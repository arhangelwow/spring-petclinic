#!groovy

node('Slave1Centos'){
    properties([
    buildDiscarder(logRotator(daysToKeepStr: '10', numToKeepStr: '10'))
    ])
    def server = Artifactory.server 'Art'
    def mvnHome = tool 'MavenPet_3.6.3'  //global variable for maven installations in jenkins
    buildName '${JOB_NAME}_${BUILD_NUMBER}'
    timestamps{//timestamps, Prepend all console output generated by the Pipeline run with the time at which the line was emitted
        stage ('GitHub Preparation') {
            checkout scm
        }//stage 1
        stage ('Maven clean + compile') {
            withEnv(["PATH+MAVEN=${mvnHome}/bin"]) {
                sh "mvn clean compile"
            }
        }//stage 2
        stage ('Maven package') {
            withEnv(["PATH+MAVEN=${mvnHome}/bin"]) {
                sh "mvn package"
            }
        }//stage 3
        stage('SonarQube Analysis') {
            withSonarQubeEnv('sonar') {
                withEnv(["PATH+MAVEN=${mvnHome}/bin"]) {
                    sh '''cd ${WORKSPACE}/
                        mvn sonar:sonar'''
                }
            }
        }//stage 4 
        stage("Quality Gate"){
            timeout(time: 1, unit: 'HOURS') {
                def qg = waitForQualityGate()
                if (qg.status != 'OK') {
                    echo "Pipeline aborted due to quality gate failure: ${qg.status}"
                }
            }
        }//stage 5
        stage ('Artifactory') {
            withEnv(["PATH+MAVEN=${mvnHome}/bin"]) {
                def IMAGE = readMavenPom().getArtifactId()
                def VERSION = readMavenPom().getVersion()
                def uploadSpec = 
                """
                {
                "files": [
                    {
                    "pattern": "${env.WORKSPACE}/target/*.jar",
                    "target": "libs-release-local/${IMAGE}_${VERSION}_${BUILD_TIMESTAMP}_${BUILD_NUMBER}.jar",
                    "props": "type=jar;status=ready"
                    }
                  ]
                }
                """
                buildInfo=server.upload(uploadSpec) 
                server.publishBuildInfo(buildInfo)  
            }
        }//stage 6
    }
}
